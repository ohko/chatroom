<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Chatroom demo</title>
	<style>
		.boxs {
			display: flex;
		}

		.box {
			flex: 1;
		}

		textarea {
			width: 100%;
		}
	</style>
</head>

<body>
	<input type="button" onclick="init()" value="init">
	<pre id="log"></pre>

	<div class="boxs">
		<fieldset class="box">
			<figcaption>Chat1: user1=>user2</figcaption>
			<textarea rows="10" id="sample0"></textarea>
			<form onsubmit="return send(this,0)">
				<input placeholder="content" name="Content" value="Hello1">
				<input type="submit">
			</form>
		</fieldset>

		<fieldset class="box">
			<figcaption>Chat2: user2=>user1</figcaption>
			<textarea rows="10" id="sample1"></textarea>
			<form onsubmit="return send(this,1)">
				<input placeholder="content" name="Content" value="Hello2">
				<input type="submit">
			</form>
		</fieldset>

		<fieldset class="box">
			<figcaption>User List</figcaption>
			<div id="userList"></div>
		</fieldset>

		<fieldset class="box">
			<figcaption>Chat3: selected</figcaption>
			<textarea rows="10" id="sample2"></textarea>
			<form onsubmit="return send(this,2)">
				<input placeholder="content" name="Content" value="Hello3">
				<input type="submit">
			</form>
		</fieldset>
	</div>
	<hr>
	<div class="boxs">
		<fieldset class="box">
			<figcaption>Group1: user1</figcaption>
			<textarea rows="10" name="group"></textarea>
			<form onsubmit="return send(this,0,1)">
				<input placeholder="content" name="Content" value="Hello group1">
				<input type="submit">
			</form>
		</fieldset>

		<fieldset class="box">
			<figcaption>Group2: user2</figcaption>
			<textarea rows="10" name="group"></textarea>
			<form onsubmit="return send(this,1,1)">
				<input placeholder="content" name="Content" value="Hello group2">
				<input type="submit">
			</form>
		</fieldset>

		<fieldset class="box">
			<figcaption>Group List</figcaption>
			<div id="groupList"></div>
		</fieldset>

		<fieldset class="box">
			<figcaption>Group3: selected</figcaption>
			<textarea rows="10" name="selected_group"></textarea>
			<form onsubmit="return send(this,2,1)">
				<input placeholder="content" name="Content" value="Hello group3">
				<input type="submit">
			</form>
		</fieldset>
	</div>

	<script>
		const apiURL = "http://127.0.0.1:8080/api"
		const wsURL = "ws://127.0.0.1:8080/ws"

		let Token = ""
		let users = [
			{ RealName: "User1", Account: "user1", Password: "user1", Token: "" },
			{ RealName: "User2", Account: "user2", Password: "user2", Token: "" },
		]
		let wsArr = [null, null]
		let GroupID = 0
		let SelectedGroupID = 0

		function onMessage(x) {
			try {
				let msg = JSON.parse(x.data)
				if (msg.Type == "text") {
					let index
					let toUser
					let fromUser
					for (let i = 0; i < users.length; i++) {
						if (users[i].UserID == msg.FromUserID) fromUser = users[i]
						if (users[i].UserID == msg.ToUserID) toUser = users[i]
						if (users[i].UserID == msg.ToUserID) index = i
					}
					if (msg.GroupID) {
						if (msg.GroupID == SelectedGroupID) {
							if (msg.FromUserID != msg.ToUserID) document.querySelector(`[name=selected_group]`).value += msg.FromUser.RealName + ":" + msg.Content + "\n"
						} else {
							let els = document.querySelectorAll(`[name=group]`)
							for (let i = 0; i < els.length; i++) {
								if (i == 0 && index == i && msg.FromUserID != msg.ToUserID) {
									els[i].value += msg.FromUser.RealName + ":" + msg.Content + "\n"
								}
								if (i == 1 && index == i && msg.FromUserID != msg.ToUserID) {
									els[i].value += msg.FromUser.RealName + ":" + msg.Content + "\n"
								}
							}
						}
					}
					else document.querySelector(`#sample${index}`).value += msg.FromUser.RealName + ":" + msg.Content + "\n"
				} else if (msg.Type == "ping") {
					this.send({ Type: "pong" })
				}
			} catch (e) {
				console.log(e)
			}
		}

		function init() {
			for (let i = 0; i < users.length; i++) {
				users[i].Token = ""
			}
			for (let i = 0; i < users.length; i++) {
				register(i)
			}
		}
		function register(index) {
			let user = users[index]
			fetch("/api/Register", {
				method: "POST", headers: { "Content-Type": "application/json" },
				body: JSON.stringify(user),
			}).then(x => x.json()).then(x => {
				let msg = ""
				if (x.no != 0) msg = `[Register] ${user.RealName} ${x.data}\n`
				else msg = `[Register] ${user.RealName} register success\n`
				document.querySelector("#log").innerHTML += msg
				login(index)
			})
			return false
		}

		function login(index) {
			let user = users[index]
			fetch("/api/Login", {
				method: "POST", headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ Account: user.Account, Password: user.Password }),
			}).then(x => x.json()).then(x => {
				user.Token = ""
				let msg = ""
				if (x.no != 0) msg = `[Login] ${user.RealName} ${x.data}\n`
				else {
					user.Token = x.data.Token
					msg = `[Login] ${user.RealName} login success\n`
					refreshUserList(user.Token)
				}
				document.querySelector("#log").innerHTML += msg

				wsArr[index] = new WS(index, wsURL, onMessage)
			})
			return false
		}

		function refreshUserList(token) {
			for (let i = 0; i < users.length; i++) {
				if (users[i].Token == "") return
			}
			fetch("/api/UserList", {
				method: "POST", headers: { "Content-Type": "application/json", "Token": token },
				body: JSON.stringify({}),
			}).then(x => x.json()).then(x => {
				if (x.no != 0) return document.querySelector("#log").innerHTML += `[UserList] ${x.data}\n`
				document.querySelector("#log").innerHTML += `[UserList] success\n`

				document.querySelector("#userList").innerHTML = ""
				for (let i = 0; i < x.data.length; i++) {
					document.querySelector("#userList").innerHTML += `<div id="user${x.data[i]["UserID"]}">${x.data[i]["UserID"]}. ${x.data[i]["Account"]} [<a href="javascript:void(useUser(${x.data[i]["UserID"]},'${x.data[i]["Account"]}'))">USE</a>] [<a href="javascript:void(delUser(${x.data[i]["UserID"]}))">DEL</a>]</div>`
					for (let j = 0; j < users.length; j++) {
						if (users[j].Account == x.data[i].Account) users[j].UserID = x.data[i].UserID
					}
				}

				refreshGroup(token)
			})
		}

		function refreshGroup(token) {
			fetch("/api/GroupListAll", {
				method: "POST", headers: { "Content-Type": "application/json", "Token": token },
				body: JSON.stringify({}),
			}).then(x => x.json()).then(x => {
				if (x.no != 0) return document.querySelector("#log").innerHTML += `[GroupListAll] ${x.data}\n`
				document.querySelector("#log").innerHTML += `[GroupListAll] success\n`

				if (x.data.length == 0) return setTimeout(_ => { createGroup(token) }, 1000)

				document.querySelector("#groupList").innerHTML = ""
				for (let i = 0; i < x.data.length; i++) {
					if (GroupID == 0) GroupID = x.data[i].GroupID
					document.querySelector("#groupList").innerHTML += `<div id="group${x.data[i]["GroupID"]}">${x.data[i]["GroupID"]}. ${x.data[i]["GroupName"]} [<a href="javascript:void(useGroup(${x.data[i]["GroupID"]}))">USE</a>] [<a href="javascript:void(delGroup(${x.data[i]["GroupID"]}))">DEL</a>]</div>`
				}
			})
		}

		function createGroup(token) {
			let ids = []
			for (let i = 0; i < users.length; i++) {
				if (users[i].Token == "") return
				ids.push(users[i].UserID)
			}
			fetch("/api/GroupCreate", {
				method: "POST", headers: { "Content-Type": "application/json", "Token": token },
				body: JSON.stringify({ GroupName: "Group", Users: ids }),
			}).then(x => x.json()).then(x => {
				if (x.no != 0) return document.querySelector("#log").innerHTML += `[GroupCreate] ${x.data}\n`
				document.querySelector("#log").innerHTML += `[GroupCreate] success\n`
				GroupID = x.data.GroupID

				refreshGroup(token)
			})
		}

		function useUser(userID, account) {
			users.length = 2
			users.push({ UserID: userID, Account: account, Password: account })
			login(2)
		}
		function useGroup(groupID) {
			SelectedGroupID = groupID
		}

		function delUser(userID) {
			fetch("/api/UserDelete", {
				method: "POST", headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ UserID: userID }),
			}).then(x => x.json()).then(x => {
				if (x.no != 0) return document.querySelector("#log").innerHTML += `[UserDelete] ${x.data}\n`
				document.querySelector("#log").innerHTML += `[UserDelete] success\n`
				document.querySelector("#user" + userID).remove()
			})
		}

		function delGroup(groupID) {
			fetch("/api/GroupDelete", {
				method: "POST", headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ GroupID: groupID }),
			}).then(x => x.json()).then(x => {
				if (x.no != 0) return document.querySelector("#log").innerHTML += `[GroupDelete] ${x.data}\n`
				document.querySelector("#log").innerHTML += `[GroupDelete] success\n`
				document.querySelector("#group" + groupID).remove()
			})
		}

		function send(o, index, isGroup) {
			let ws = wsArr[index]
			let fromUser = users[index]
			let toUser = users[index == 1 ? 0 : 1]
			let groupID = (isGroup && GroupID) ? GroupID : 0
			if (isGroup && SelectedGroupID) groupID = SelectedGroupID
			ws.send({
				Type: "text",
				ToUserID: (!isGroup) ? toUser.UserID : 0,
				GroupID: groupID,
				Content: o.Content.value
			})
			return false
		}

		class WS {
			constructor(index, url, onMsg) {
				this.index = index
				this.url = url
				this.onMsg = onMsg
				this.connect()
			}
			send(data) {
				this.ws.send(JSON.stringify(data))
			}
			onmessage(e) {
				try {
					let data = JSON.parse(e.data)
					switch (data.Type) {
						case "pong": console.log("pong"); break
						default: this.onMsg && this.onMsg(e)
					}
				} catch (e) {
					console.log(e)
				}
			}
			connect() {
				console.log("Connection connect...")
				this.ws = new WebSocket(this.url)
				this.ws.onopen = this.onopen.bind(this)
				this.ws.onerror = this.onerror.bind(this)
				this.ws.onclose = this.onclose.bind(this)
				this.ws.onmessage = this.onmessage.bind(this)
			}
			onerror(e) {
				console.log(e)
			}
			onopen() {
				console.log("Connection connect success")
				this.send({ Type: "bind", Token: users[this.index].Token })
			}
			onclose(e) {
				console.log("Connection closed")
				setTimeout(this.connect.bind(this), 3000)
			}
		}

		init()
	</script>
</body>

</html>